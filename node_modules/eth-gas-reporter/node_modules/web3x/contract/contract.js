"use strict";
/*
  This file is part of web3x.

  web3x is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  web3x is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with web3x.  If not, see <http://www.gnu.org/licenses/>.
*/
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const util_1 = require("util");
const subscriptions_1 = require("../subscriptions");
const abi_1 = require("./abi");
const tx_1 = require("./tx");
const decode_event_abi_1 = require("./decode-event-abi");
const formatters_1 = require("../formatters");
const utils_1 = require("../utils");
const tx_deploy_1 = require("./tx-deploy");
const errors_1 = require("../errors");
/**
 * Should be called to create new contract instance
 *
 * @method Contract
 * @constructor
 * @param {Array} jsonInterface
 * @param {String} address
 * @param {Object} options
 */
class Contract {
    constructor(eth, jsonInterface, address, defaultOptions = {}, wallet) {
        this.eth = eth;
        this.jsonInterface = jsonInterface;
        this.address = address;
        this.wallet = wallet;
        this.contractDeployFormatter = receipt => {
            this.setAddress(receipt.contractAddress);
            return receipt;
        };
        this.receiptFormatter = (receipt) => {
            if (!util_1.isArray(receipt.logs)) {
                return receipt;
            }
            // decode logs
            const decodedEvents = receipt.logs.map(log => decode_event_abi_1.decodeAnyEvent(this.jsonInterface, log));
            // make log names keys
            receipt.events = {};
            receipt.unnamedEvents = [];
            for (let ev of decodedEvents) {
                if (ev.event) {
                    const events = receipt.events[ev.event] || [];
                    receipt.events[ev.event] = [...events, ev];
                }
                else {
                    receipt.unnamedEvents = [...receipt.unnamedEvents, ev];
                }
            }
            delete receipt.logs;
            return receipt;
        };
        this.jsonInterface = this.getEnrichedAbiDefinition(jsonInterface);
        this.methods = this.getMethods(this.jsonInterface);
        this.events = this.getEvents(this.jsonInterface);
        const { gasPrice, from, gas } = defaultOptions;
        this.options = {
            gas,
            gasPrice,
            from: from ? utils_1.toChecksumAddress(formatters_1.inputAddressFormatter(from)) : undefined,
        };
        if (address) {
            this.setAddress(address);
        }
        this.extraFormatters = {
            receiptFormatter: this.receiptFormatter,
            contractDeployFormatter: this.contractDeployFormatter,
        };
    }
    /**
     * Deploys a contract and fire events based on its state: transactionHash, receipt
     * contract.deploy(data, 1, 2).send({ from: 0x123... });
     *
     * All event listeners will be removed, once the last possible event is fired ("error", or "receipt")
     */
    deploy(data, ...args) {
        const constructor = this.jsonInterface.find(method => method.type === 'constructor') || {
            type: 'constructor',
        };
        constructor.signature = 'constructor';
        return new tx_deploy_1.TxDeploy(this.eth, constructor, data, args, this.options, this.wallet, this.extraFormatters);
    }
    /**
     * Adds event listeners and creates a subscription, and remove it once its fired.
     *
     * @method once
     * @param {String} event
     * @param {Object} options
     * @param {Function} callback
     * @return {Object} the event subscription
     */
    once(event, options, callback) {
        // don't return as once shouldn't provide "on"
        this.on(event, options, (err, res, sub) => {
            sub.unsubscribe();
            callback(err, res, sub);
        });
    }
    /**
     * Adds event listeners and creates a subscription.
     */
    on(event, options = {}, callback) {
        const logOptions = this.getLogOptions(event, options);
        const { fromBlock } = logOptions, subLogOptions = tslib_1.__rest(logOptions, ["fromBlock"]);
        var subscription = new subscriptions_1.Subscription('eth', 'logs', [formatters_1.inputLogFormatter(subLogOptions)], this.eth.provider);
        subscription
            .on('rawdata', log => {
            const output = decode_event_abi_1.decodeAnyEvent(this.jsonInterface, log);
            if (output.removed) {
                subscription.emit('changed', output);
            }
            else {
                subscription.emit('data', output);
            }
            if (callback) {
                callback(undefined, output, subscription);
            }
        })
            .on('error', err => {
            if (callback) {
                callback(err, undefined, subscription);
            }
        });
        if (fromBlock !== undefined) {
            this.eth
                .getPastLogs(logOptions)
                .then(logs => {
                logs.forEach(log => subscription.emit('rawdata', log));
                subscription.subscribe();
            })
                .catch(err => {
                subscription.emit('error', err);
            });
        }
        else {
            process.nextTick(() => subscription.subscribe());
        }
        return subscription;
    }
    getPastEvents(event, options = {}) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const logOptions = this.getLogOptions(event, options);
            const result = yield this.eth.getPastLogs(logOptions);
            return result.map(log => decode_event_abi_1.decodeAnyEvent(this.jsonInterface, log));
        });
    }
    executorFactory(definition, nextOverload) {
        return (...args) => {
            if (!this.address) {
                throw new Error('No contract address.');
            }
            if ((!args && definition.inputs && definition.inputs.length > 0) ||
                (definition.inputs && args.length !== definition.inputs.length)) {
                if (nextOverload) {
                    return nextOverload(...args);
                }
                throw errors_1.InvalidNumberOfParams(args.length, definition.inputs.length, definition.name);
            }
            return new tx_1.Tx(this.eth, definition, this.address, args, this.options, this.wallet, this.extraFormatters);
        };
    }
    setAddress(address) {
        this.address = utils_1.toChecksumAddress(formatters_1.inputAddressFormatter(address));
    }
    getMethods(contractDefinition) {
        const methods = {};
        contractDefinition
            .filter(method => method.type === 'function')
            .forEach(method => {
            const name = method.name;
            const funcName = abi_1.abiMethodToString(method);
            method.signature = abi_1.abi.encodeFunctionSignature(funcName);
            const func = this.executorFactory(method);
            // add method only if not one already exists
            if (!methods[name]) {
                methods[name] = func;
            }
            else {
                const cascadeFunc = this.executorFactory(method, methods[name]);
                methods[name] = cascadeFunc;
            }
            // definitely add the method based on its signature
            methods[method.signature] = func;
            // add method by name
            methods[funcName] = func;
        });
        return methods;
    }
    getEvents(contractDefinition) {
        const events = {};
        contractDefinition
            .filter(method => method.type === 'event')
            .forEach(method => {
            const name = method.name;
            const funcName = abi_1.abiMethodToString(method);
            const event = this.on.bind(this, method.signature);
            // add method only if not already exists
            if (!events[name] || events[name].name === 'bound ')
                events[name] = event;
            // definitely add the method based on its signature
            events[method.signature] = event;
            // add event by name
            events[funcName] = event;
        });
        // add allEvents
        events.allEvents = this.on.bind(this, 'allevents');
        return events;
    }
    getEnrichedAbiDefinition(contractDefinition) {
        return contractDefinition.map(method => {
            // make constant and payable backwards compatible
            const constant = method.stateMutability === 'view' || method.stateMutability === 'pure' || method.constant;
            const payable = method.stateMutability === 'payable' || method.payable;
            method = Object.assign({}, method, { constant,
                payable });
            // function
            if (method.type === 'function') {
                method = Object.assign({}, method, { signature: abi_1.abi.encodeFunctionSignature(abi_1.abiMethodToString(method)) });
            }
            else if (method.type === 'event') {
                method = Object.assign({}, method, { signature: abi_1.abi.encodeEventSignature(abi_1.abiMethodToString(method)) });
            }
            return method;
        });
    }
    /**
     * Should be used to encode indexed params and options to one final object
     *
     * @method _encodeEventABI
     * @param {Object} event
     * @param {Object} options
     * @return {Object} everything combined together and encoded
     */
    getEventTopics(event, options) {
        let topics = [];
        // add event signature
        if (!event.anonymous && event.signature) {
            topics.push(event.signature);
        }
        // add event topics (indexed arguments)
        const indexedTopics = (event.inputs || [])
            .filter(input => input.indexed === true)
            .map(input => {
            const filter = options.filter || {};
            const value = filter[input.name];
            if (!value) {
                return null;
            }
            // TODO: https://github.com/ethereum/web3.js/issues/344
            // TODO: deal properly with components
            if (util_1.isArray(value)) {
                return value.map(v => abi_1.abi.encodeParameter(input.type, v));
            }
            else {
                return abi_1.abi.encodeParameter(input.type, value);
            }
        });
        return [...topics, ...indexedTopics];
    }
    /**
     * Gets the event signature and outputformatters
     */
    getLogOptions(eventName = 'allevents', options) {
        if (!utils_1.isAddress(this.address)) {
            throw new Error("This contract object doesn't have address set yet, please set an address first.");
        }
        if (eventName.toLowerCase() === 'allevents') {
            return Object.assign({}, options, { address: this.address });
        }
        const event = this.jsonInterface.find(json => json.type === 'event' && (json.name === eventName || json.signature === '0x' + eventName.replace('0x', '')));
        if (!event) {
            throw new Error('Event "' + eventName + '" doesn\'t exist in this contract.');
        }
        return Object.assign({}, options, { address: this.address, topics: this.getEventTopics(event, options) });
    }
}
exports.Contract = Contract;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJhY3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29udHJhY3QvY29udHJhY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7Ozs7RUFlRTs7O0FBRUYsK0JBQStCO0FBQy9CLG9EQUFnRDtBQUNoRCwrQkFBK0M7QUFDL0MsNkJBQXFDO0FBQ3JDLHlEQUFvRDtBQUNwRCw4Q0FBc0g7QUFDdEgsb0NBQXdEO0FBQ3hELDJDQUF1QztBQUl2QyxzQ0FBa0Q7QUFrQ2xEOzs7Ozs7OztHQVFHO0FBQ0gsTUFBYSxRQUFRO0lBTW5CLFlBQ1UsR0FBUSxFQUNSLGFBQTBCLEVBQzNCLE9BQWdCLEVBQ3ZCLGlCQUFrQyxFQUFFLEVBQzVCLE1BQWU7UUFKZixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBQ1Isa0JBQWEsR0FBYixhQUFhLENBQWE7UUFDM0IsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUVmLFdBQU0sR0FBTixNQUFNLENBQVM7UUE2U2pCLDRCQUF1QixHQUFHLE9BQU8sQ0FBQyxFQUFFO1lBQzFDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ3pDLE9BQU8sT0FBTyxDQUFDO1FBQ2pCLENBQUMsQ0FBQztRQUVNLHFCQUFnQixHQUFHLENBQUMsT0FBMkIsRUFBRSxFQUFFO1lBQ3pELElBQUksQ0FBQyxjQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUMxQixPQUFPLE9BQU8sQ0FBQzthQUNoQjtZQUVELGNBQWM7WUFDZCxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLGlDQUFjLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBRXZGLHNCQUFzQjtZQUN0QixPQUFPLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMs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